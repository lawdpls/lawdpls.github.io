<!DOCTYPE html>
<html>
<meta charset="utf-8">

<style>
h1 {
    font-family: 'Raleway',sans-serif; 
    font-size: 62px; 
    font-weight: 800; 
    line-height: 72px; 
    text-align: center; 
    text-transform: uppercase;
    margin: 0;
    padding: 0; 
}
div{
    text-align: center;
    padding-top: 50px;
}
.button {
    background-color: lightgray;
    border: 1px gray;
    color: black;
    padding: 15px 32px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 16px;
    cursor: pointer;
    float: right;
    position: relative;
    left: -40%;

}
.button:hover {
    background-color: black;
    color:white;
}
</style>

<body>
<h1 align=center> Animated Transitions </h1>
<button id="bubButt" class="button">Bubble</button>
<button id="scaButt" class="button">Scatter</button>
<button id="barButt" class="button">Bar</button>
<div></div>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script>
var margin = {top:40, bottom:40, right:40, left:20},
    height = 600 - margin.top - margin.bottom,
    width = 1000 - margin.right - margin.left,
    duration,
	svg = d3.select("div")
            .append("svg")
            .attr("height", height + margin.top + margin.bottom)
            .attr("width", width + margin.right + margin.left),
    canvas = svg.append("g")
                .attr("id", "canvas")
    		    .attr("transform", "translate(" + margin.left + " " + margin.top + ")"),
    chartType = {
        bar: "1",
        Scatter: "2",
        Bubble: "3"
    },
    currentType = "0";
var	color = d3.scaleOrdinal(d3.schemeCategory20);

d3.csv("https://lawdpls.github.io/03/fruit.csv", function(err, data) {
	if(err) {
		console.log(err);
	}
	data.forEach(function (d) {
        d.Count = Number(d.Count);
    });
	var fruits = [];
    for (i = 0; i<data.length;i++){
    	fruits[i] = data[i].Fruit;
    }

    barChart(data);

	d3.select("#barButt")
        .on("click", function () {
            barChart(data);
            d3.event.preventDefault();
        });
    d3.select("#bubButt")
        .on("click", function () {
            bubbleChart(data);
            d3.event.preventDefault();
        });
    d3.select("#scaButt")
        .on("click", function () {
            scatterChart(data);
            d3.event.preventDefault();
        });

function transit () {
    duration = 0;
    if(currentType === chartType.bar) {
            duration = 1000;
            canvas.select("#barX")
                .transition()
                .duration(duration)
                .attr("transform", "translate(0 " + (height + 40) + ")")
                .remove();
            canvas.select("#barY")
                .transition()
                .duration(duration)
                .attr("transform", "translate(-40 0)")
                .remove();
    } else if (currentType === chartType.Scatter) {
            duration = 1000;
            canvas.selectAll(".grid")
                .transition()
                .duration(duration*1.5)
                .attr("transform", "translate(1000 0)")
                .remove();
            canvas.selectAll(".scaLabel")
                  .transition()
                  .duration(duration)
                  .attr("transform", "translate(1000 0)")
                  .remove()
            canvas.selectAll(".scaY")
                  .transition()
                  .duration(duration)
                  .style("opacity", 0)
                  .remove()
    } else if (currentType === chartType.Bubble) {
            duration = 1000;
            canvas.selectAll(".unit")
                .select("text")
                .transition()
                .duration(duration)
                .style("opacity", 0)
                .remove();
    }
    return duration;
}

function barChart (data) {
    if (currentType !== chartType.bar) {
    currentType = chartType.bar;

    var delay = transit();

        xScale = d3.scaleBand()
        		   .domain(fruits)
        		   .range([0, width])
        		   .padding(0),
        max = d3.max(data, function(d) { return d.Count; }),
    	yScale = d3.scaleLinear()
        		   .domain([0, max])
        		   .range([height, 0]),
    	xAxis = canvas.append("g")
        			  .attr("id", "barX")
        			  .attr("transform", "translate(0 " + (height + 40) + ")")
        			  .call(d3.axisBottom(xScale)),
    	yAxis = canvas.append("g")
        			  .attr("id", "barY")
        			  .attr("transform", "translate(-30 0)")
        			  .call(d3.axisLeft(yScale)),
        barWid = xScale.bandwidth();

    canvas.selectAll(".unit")
          .data(data)
          .enter()
          .append("g")
          .attr("class", "unit")
          .append("rect")
          .attr("x", function (d) { return xScale(d.Fruit); })
          // .attr("x", function (d) { return xScale(fruits); }) This will change the way bar appear
          .attr("y", height)
          .attr("width", barWid)
          .attr("height", 0)
          .style("fill", function (d) { return color(d.Fruit); });
        // .style("stroke", "black")
        // .style("stroke-width", 0)
        // .on("mouseover", function (d) {
        //     d3.select(this).style("stroke-width", 2)
        // })
        // .on("mouseout", function (d) {
        //     d3.select(this).style("stroke-width", 0);
        // });
    var bar = canvas.selectAll(".unit")
        			// .data(data)
        			.select("rect")
          			.transition()
        			.delay(1000)
					.duration(2000);
        // .delay(delay);
    // if (currentType === chartType.Bubble) {
    //     bar = bar.duration(2000)
            // .attr("x", function (d) { return xScale(d.Fruit); })
            // .attr("y", 250 - barWid / 2)
            // .attr("width", barWid)
            // .attr("height", barWid)
            // .attr("rx", barWid / 2)
    //         .transition()
    //         .duration(1000);
    //     delay += 3000;
    // } else {
    //     bar = bar.duration(2000);
    //     delay += 2000;
    // }
    bar.attr("rx", 0)
        .attr("x", function (d) { return xScale(d.Fruit); })
        .attr("y", function (d) { return yScale(d.Count); })
        .attr("width", barWid)
        .attr("height", function (d) { return height - yScale(d.Count); });
    xAxis.transition()
        .delay(2500)
         .duration(1000)
         .attr("transform", "translate(0 " + height + ")");
    yAxis.transition()
        .delay(2500)
         .duration(1000)
         .attr("transform", "translate(0 0)");
    }
}

function scatterChart (data) {
    if(currentType !== chartType.Scatter){
    currentType = chartType.Scatter;

    var delay = transit();
    canvas.selectAll(".unit").select("rect")
        .data(data)
        .transition()
        .delay(delay)
        .duration(1000)
        .attr("x", function (d) { return xScale(d.Fruit)+27.5; })
        .attr("y", function (d) { return yScale(d.Count)-5; })
        // .attr("width", function (d) { return x(d.Count); })
        .attr("height", 10)
        .attr("width", 10)
        .attr("rx", 5);
        // .style("shape-rendering", "crispEdges");
    
    canvas.selectAll(".grid")
          .data(d3.range(25))
          .enter()
          .append("g")
          .attr("class", "grid")
          .append("line")
          .attr("x1", 0)
          .attr("y1", function(d){return yScale(d);})
          .attr("x2", 0)
          .attr("y2", function(d){return yScale(d);})
          .attr("stroke", "gray")
          .style("stroke-dasharray", ("4,4"))
          .attr("stroke-width", 0.8)
          .transition()
          .delay(1000)
          .duration(1000)
          .attr("x2", width);

    canvas.selectAll(".scaLabel")
          .data(data)
          .enter()
          .append("g")
          .attr("class", "scaLabel")
          .append("text")
          .style("fill", "black")
          .style("opacity", 0)
          .attr("x", -100)
          .attr("y", function(d) {return yScale(d.Count)-10})
          .text(function(d) {return d.Fruit})
          .transition()
          .delay(1000)
          .duration(2000)
          .style("opacity", 0.8)
          .attr("x", function(d) {return xScale(d.Fruit)+10})

    canvas.selectAll(".scaY")
          .data(d3.range(max+1))
          .enter()
          .append("g")
          .attr("class", "scaY")
          .append("text")
          .style("fill", "gray")
          .style("opacity", 0)
          .attr("x", function(d){
            return d%2 === 1? -10: width;
          })
          .attr("y", function(d) {return yScale(d)})
          .text(function(d){return d})
          .transition()
          .delay(1000)
          .duration(2000)
          .style("opacity", 1)
    }
}

function bubbleChart (data) {
    if(currentType !== chartType.Bubble) {
    currentType = chartType.Bubble;

    var delay = transit();
    var pack = d3.pack()
                 .size([width, height])
                 .padding(5);
        
    var root = d3.hierarchy({children: data})
        .sum(function (d) { return d.Count; })
        .sort(function (a, b) { return a.Count - b.Count; })
    pack(root);
    function dataKey (d) {
        return d.data ? d.data.Fruit : d.Fruit;
    }
    var Bubble = svg.selectAll(".unit")
        .data(root.descendants(), dataKey);
    
    var rects = Bubble.select("rect")
        .transition()
        .delay(delay)
    // if (currentType === chartType.bar) {
    //     rects = rects.duration(1000)
            // .attr("y", 250 - barWid / 2)
            // .attr("width", barWid)
            // .attr("height", barWid)
            // .attr("rx", barWid)
            // .transition()
            .duration(2000)
    //     delay += 3000;
    // } else {
    //     rects = rects.duration(2500);
    //     delay += 2500;
    // }
    
        .attr("rx", function (d) { return d.r; })
        .attr("x", function (d) { return d.x - d.r; })
        .attr("y", function (d) { return d.y - d.r; })
        .attr("width", function (d) { return d.r*2; })
        .attr("height", function (d) { return d.r*2; })
        .style("shape-rendering", "auto");
    Bubble.append("text")
        .attr("x", function (d) { return d.x; })
        .attr("y", function (d) { return (d.y+5); })
        .style("fill", "black")
        .style("font-size", "0.9em")
        .style("text-anchor", "middle")
        .style("opacity", 0)
        .text(function (d) { return d.data.Fruit; })
        .transition()
        .delay(delay + 1500)
        .duration(2000)
        .style("opacity", 1);
    }
}

});
</script>
</body>
</html>